<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bitback.one — bezpieczne udostępnianie danych</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
            padding-bottom: 2.5rem;
        }

        .header {
            text-align: center;
            padding: 2rem 1rem 1.5rem;
        }
        .header h1 {
            font-size: 1.6rem;
            font-weight: 300;
            letter-spacing: 0.08em;
            color: #fff;
        }
        .header p {
            color: #555;
            font-size: 0.8rem;
            margin-top: 0.3rem;
        }

        /* ====== TRUST BAR ====== */
        .trust {
            max-width: 1100px;
            margin: 0 auto 1.5rem;
            padding: 0 1rem;
        }
        .trust-box {
            background: #0d0d0d;
            border: 1px solid #1a1a1a;
            border-radius: 10px;
            padding: 1.2rem 1.5rem;
        }
        .trust-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.2rem;
        }
        @media (max-width: 768px) {
            .trust-grid { grid-template-columns: 1fr; }
        }
        .trust-item { }
        .trust-icon {
            font-size: 1.1rem;
            margin-bottom: 0.3rem;
        }
        .trust-title {
            font-size: 0.72rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #888;
            margin-bottom: 0.25rem;
        }
        .trust-desc {
            font-size: 0.7rem;
            color: #444;
            line-height: 1.5;
        }

        /* ====== HINT BAR ====== */
        .hint-bar {
            background: #111;
            border: 1px solid #1e1e1e;
            border-radius: 8px;
            padding: 0.6rem 0.8rem;
            margin-bottom: 0.6rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.75rem;
            color: #555;
        }
        .hint-bar kbd {
            display: inline-block;
            padding: 0.15em 0.5em;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 0.8rem;
            color: #f0c060;
            white-space: nowrap;
        }
        .hint-bar .hint-text { color: #555; }
        .hint-bar .hint-text strong { color: #f0c060; font-weight: 500; }

        .main {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 1rem 3rem;
        }

        /* --- LAYOUT DWU-KOLUMNOWY --- */
        .two-col {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 1.5rem;
            align-items: start;
        }
        @media (max-width: 768px) {
            .two-col { grid-template-columns: 1fr; }
        }

        .col-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #555;
            margin-bottom: 0.6rem;
        }

        /* ====== LEWA KOLUMNA — EDYTOR ====== */
        .col-left { min-width: 0; }

        /* placeholder edytora */

        /* edytor contenteditable */
        .editor {
            width: 100%;
            min-height: 220px;
            padding: 0.8rem;
            background: #111;
            border: 1px solid #1e1e1e;
            border-radius: 8px;
            color: #ddd;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.7;
            outline: none;
            white-space: pre-wrap;
            word-break: break-word;
            cursor: text;
            transition: border-color 0.15s;
        }
        .editor:focus { border-color: #333; }
        .editor:empty::before {
            content: 'Wpisz treść tutaj...\ANp. Login: admin\AHasło: s3cret123  ← zaznacz i Ctrl+E';
            color: #333;
            pointer-events: none;
            white-space: pre-wrap;
        }

        /* oznaczone fragmenty poufne */
        .editor .secret {
            background: rgba(212, 146, 42, 0.15);
            color: #f0c060;
            border-radius: 3px;
            padding: 0.05em 0.15em;
            border-bottom: 2px solid rgba(212, 146, 42, 0.4);
        }

        /* ====== PRAWA KOLUMNA — KONFIG ====== */
        .col-right {
            position: sticky;
            top: 1.5rem;
        }

        .config-panel {
            background: #111;
            border: 1px solid #1e1e1e;
            border-radius: 8px;
            padding: 1rem;
        }

        .config-group {
            margin-bottom: 1rem;
        }
        .config-group:last-child { margin-bottom: 0; }

        .config-group label {
            display: block;
            font-size: 0.68rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #555;
            margin-bottom: 0.3rem;
        }

        .config-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .config-input {
            width: 70px;
            padding: 0.4rem 0.5rem;
            background: #0a0a0a;
            border: 1px solid #252525;
            border-radius: 4px;
            color: #fff;
            font-size: 0.85rem;
            text-align: center;
            outline: none;
        }
        .config-input:focus { border-color: #444; }

        .config-unit {
            font-size: 0.72rem;
            color: #444;
        }

        .config-sep {
            border: none;
            border-top: 1px solid #1a1a1a;
            margin: 1rem 0;
        }

        /* antybot */
        .antibot-q {
            font-size: 0.82rem;
            color: #888;
            margin-bottom: 0.4rem;
        }
        .antibot-options {
            display: flex;
            gap: 0.4rem;
        }
        .antibot-opt {
            flex: 1;
            padding: 0.45rem;
            border-radius: 5px;
            border: 1px solid #252525;
            background: #0a0a0a;
            color: #888;
            font-size: 0.85rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
            user-select: none;
        }
        .antibot-opt:hover {
            border-color: #444;
            color: #ccc;
        }
        .antibot-opt.selected {
            border-color: #3a7bd5;
            background: #0f1a2e;
            color: #6ea8f0;
        }

        /* honeypot */
        .ohnohoney {
            position: absolute;
            left: -9999px;
            opacity: 0;
            height: 0;
            width: 0;
            pointer-events: none;
        }

        /* przycisk generuj */
        .generate-btn {
            width: 100%;
            padding: 0.75rem;
            margin-top: 1rem;
            border-radius: 6px;
            border: none;
            background: #3a7bd5;
            color: #fff;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s;
            letter-spacing: 0.02em;
        }
        .generate-btn:hover { background: #4a8be5; }
        .generate-btn:active { background: #2a6bc5; }

        /* ====== PODGLĄD WYGAŚNIĘCIA ====== */
        .preview-section {
            margin-top: 1.5rem;
        }
        .preview-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .preview-bar .col-label { margin-bottom: 0; }
        .preview-tabs {
            display: flex;
            gap: 0.3rem;
        }
        .preview-tab {
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            border: 1px solid #1e1e1e;
            background: transparent;
            color: #444;
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        .preview-tab.active {
            border-color: #333;
            color: #aaa;
            background: #161616;
        }
        .preview-box {
            background: #111;
            border: 1px solid #1e1e1e;
            border-radius: 8px;
            padding: 0.8rem;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.7;
            white-space: pre-wrap;
            word-break: break-word;
            min-height: 60px;
        }
        .preview-box .masked {
            background: rgba(100, 100, 100, 0.2);
            color: #555;
            border-radius: 3px;
            padding: 0.05em 0.15em;
            letter-spacing: 0.1em;
        }
        .preview-box .secret {
            background: rgba(212, 146, 42, 0.15);
            color: #f0c060;
            border-radius: 3px;
            padding: 0.05em 0.15em;
            border-bottom: 2px solid rgba(212, 146, 42, 0.4);
        }

        /* ====== WYNIK ====== */
        .result {
            margin-top: 1.5rem;
            display: none;
        }
        .result.show { display: block; }

        .result-box {
            background: #0c1a0c;
            border: 1px solid #1a3a1a;
            border-radius: 8px;
            padding: 0.8rem 1rem;
        }
        .result-label {
            font-size: 0.68rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #4a4;
            margin-bottom: 0.4rem;
        }
        .result-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .result-url {
            flex: 1;
            padding: 0.45rem 0.6rem;
            background: #080808;
            border: 1px solid #252525;
            border-radius: 4px;
            color: #7d7;
            font-family: monospace;
            font-size: 0.8rem;
            outline: none;
        }
        .copy-btn {
            padding: 0.45rem 0.9rem;
            background: #142814;
            border: 1px solid #1a3a1a;
            border-radius: 4px;
            color: #7d7;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }
        .copy-btn:hover { background: #1e3a1e; }

        .result-password {
            margin-top: 0.6rem;
            padding: 0.5rem 0.7rem;
            background: #0a1a0a;
            border: 1px solid #1a3a1a;
            border-radius: 4px;
            font-size: 0.78rem;
            color: #6b6;
            display: none;
        }
        .result-password.show { display: block; }
        .result-password strong {
            color: #9d9;
            font-family: monospace;
            font-weight: 500;
        }

    </style>
</head>
<body>

<div class="header">
    <h1>bitback.one</h1>
    <p>bezpieczne jednorazowe linki</p>
</div>

<div class="trust">
    <div class="trust-box">
        <div class="trust-grid">
            <div class="trust-item">
                <div class="trust-icon">&#128274;</div>
                <div class="trust-title">Szyfrowanie zero-trust</div>
                <div class="trust-desc">Treść szyfrowana AES-256 w przeglądarce. Klucz deszyfrujący jest w części linka (#fragment), która nigdy nie trafia do serwera — nawet w logach. Administrator nie ma fizycznej możliwości odczytu danych.</div>
            </div>
            <div class="trust-item">
                <div class="trust-icon">&#128337;</div>
                <div class="trust-title">Kontrolowane wygasanie</div>
                <div class="trust-desc">Po wygaśnięciu linka fragmenty oznaczone jako poufne zostają trwale ukryte. Reszta treści pozostaje widoczna jako kontekst. Po usunięciu — wszystko znika bezpowrotnie.</div>
            </div>
            <div class="trust-item">
                <div class="trust-icon">&#128421;</div>
                <div class="trust-title">Bez śladu na serwerze</div>
                <div class="trust-desc">Serwer przechowuje wyłącznie zaszyfrowany blob. Klucz nie pojawia się w logach, bazie danych, ani w pamięci serwera. Deszyfrowanie odbywa się wyłącznie w przeglądarce odbiorcy.</div>
            </div>
        </div>
    </div>
</div>

<div class="main">
    <form id="createForm" autocomplete="off" onsubmit="return false;">
        <input type="text" name="website_url" class="ohnohoney" tabindex="-1" autocomplete="off">

        <div class="two-col">
            <!-- LEWA — edytor -->
            <div class="col-left">
                <div class="col-label">Treść</div>
                <div class="hint-bar">
                    <kbd>Ctrl+E</kbd>
                    <span class="hint-text">Zaznacz fragment tekstu i naciśnij <strong>Ctrl+E</strong> aby oznaczyć go jako <strong>poufny</strong>. Poufne fragmenty zostaną ukryte po wygaśnięciu linka — reszta treści pozostanie widoczna. Ponowne Ctrl+E odznacza.</span>
                </div>
                <div class="editor" id="editor" contenteditable="true" spellcheck="false"></div>

                <!-- podgląd pod edytorem -->
                <div class="preview-section">
                    <div class="preview-bar">
                        <div class="col-label">Podgląd</div>
                        <div class="preview-tabs">
                            <button type="button" class="preview-tab active" onclick="setPreview('expired', this)">po wygaśnięciu</button>
                            <button type="button" class="preview-tab" onclick="setPreview('active', this)">aktywny link</button>
                        </div>
                    </div>
                    <div class="preview-box" id="preview"></div>
                </div>
            </div>

            <!-- PRAWA — konfiguracja -->
            <div class="col-right">
                <div class="col-label">Ustawienia</div>
                <div class="config-panel">
                    <div class="config-group">
                        <label>Wygaśnięcie danych poufnych</label>
                        <div class="config-row">
                            <input type="number" class="config-input" id="expireDays" value="14" min="1" max="3650">
                            <span class="config-unit">dni</span>
                        </div>
                    </div>

                    <div class="config-group">
                        <label>Maksymalna liczba wyświetleń</label>
                        <div class="config-row">
                            <input type="number" class="config-input" id="maxViews" value="5" min="1" max="10000">
                            <span class="config-unit">razy</span>
                        </div>
                    </div>

                    <div class="config-group">
                        <label>Permanentne usunięcie po</label>
                        <div class="config-row">
                            <input type="number" class="config-input" id="deleteDays" value="90" min="0" max="3650">
                            <span class="config-unit">dni (0 = od razu)</span>
                        </div>
                    </div>

                    <div class="config-group">
                        <label>Hasło otwarcia (opcjonalne)</label>
                        <div class="config-row">
                            <input type="text" class="config-input" id="linkPassword" style="width:100%;text-align:left;" placeholder="zostaw puste = bez hasła" autocomplete="off">
                        </div>
                    </div>

                    <hr class="config-sep">

                    <div class="config-group">
                        <label>Weryfikacja</label>
                        <div class="antibot-q" id="mathQuestion"></div>
                        <div class="antibot-options" id="mathOptions"></div>
                    </div>

                    <button type="button" class="generate-btn" onclick="generateLink()">Generuj link</button>
                </div>
            </div>
        </div>
    </form>

    <div class="result" id="result">
        <div class="result-box">
            <div class="result-label">Twój link</div>
            <div class="result-link">
                <input type="text" class="result-url" id="resultUrl" readonly>
                <button type="button" class="copy-btn" onclick="copyLink()">Kopiuj</button>
            </div>
            <div class="result-password" id="resultPassword"></div>
        </div>
    </div>

</div>

<div style="position:fixed;bottom:0;left:0;right:0;z-index:100;background:#0a0a0a;border-top:1px solid #1a1a1a;padding:0.5rem 1rem;text-align:center;font-size:0.75rem;color:#555;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
    <a href="https://bitback.pl" target="_blank" rel="noopener" style="color:#6a9fd4;text-decoration:none;"><strong>bitback.pl</strong></a>
    <span style="color:#2a2a2a;margin:0 0.5rem;">|</span>Zabezpieczamy pocztę, serwery i komputery
    <span style="color:#2a2a2a;margin:0 0.5rem;">|</span>Zbigniew Gralewski
    <span style="color:#2a2a2a;margin:0 0.5rem;">|</span><a href="mailto:zbigniew.gralewski@bitback.pl" style="color:#6a9fd4;text-decoration:none;">zbigniew.gralewski@bitback.pl</a>
    <span style="color:#2a2a2a;margin:0 0.5rem;">|</span>609 505 065
    <span style="color:#2a2a2a;margin:0 0.5rem;">|</span>Kod źródłowy na <a href="https://github.com/bitback/bitback.one" target="_blank" rel="noopener" style="color:#6a9fd4;text-decoration:none;">GitHub</a>
</div>

<script>
    const editor = document.getElementById('editor');
    let mathA, mathB;
    let previewMode = 'expired';

    // --- MATH ANTYBOT (klikalne opcje) ---
    let selectedAnswer = null;

    function generateMath() {
        mathA = Math.floor(Math.random() * 15) + 1;
        mathB = Math.floor(Math.random() * 15) + 1;
        selectedAnswer = null;

        const correct = mathA + mathB;
        // wygeneruj 2 fałszywe odpowiedzi (różne od poprawnej i od siebie)
        const fakes = new Set();
        while (fakes.size < 2) {
            const f = correct + (Math.floor(Math.random() * 7) - 3); // ±3
            if (f !== correct && f > 0) fakes.add(f);
        }

        const options = [correct, ...fakes];
        // shuffle
        for (let i = options.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [options[i], options[j]] = [options[j], options[i]];
        }

        document.getElementById('mathQuestion').textContent = `${mathA} + ${mathB} = ?`;
        const container = document.getElementById('mathOptions');
        container.innerHTML = '';
        options.forEach(val => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'antibot-opt';
            btn.textContent = val;
            btn.addEventListener('click', () => {
                container.querySelectorAll('.antibot-opt').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedAnswer = val;
            });
            container.appendChild(btn);
        });
    }
    generateMath();

    // --- TOGGLE SECRET (oznacz / odznacz) ---
    function toggleSecret() {
        const sel = window.getSelection();
        if (!sel.rangeCount) return;

        // sprawdź czy kursor/zaznaczenie jest wewnątrz .secret
        const anchorParent = sel.anchorNode.nodeType === 3 ? sel.anchorNode.parentElement : sel.anchorNode;
        const secretEl = anchorParent ? anchorParent.closest('.secret') : null;

        if (secretEl && editor.contains(secretEl)) {
            // --- ODZNACZ ---
            // wstaw marker <span> tuż za secretEl, żeby po unwrap+normalize mieć punkt odniesienia
            const marker = document.createElement('span');
            marker.setAttribute('data-cursor', '1');
            secretEl.parentNode.insertBefore(marker, secretEl.nextSibling);

            const parent = secretEl.parentNode;
            while (secretEl.firstChild) {
                parent.insertBefore(secretEl.firstChild, secretEl);
            }
            parent.removeChild(secretEl);
            parent.normalize();

            // postaw kursor przed markerem, usuń marker
            const r = document.createRange();
            r.setStartBefore(marker);
            r.collapse(true);
            marker.remove();
            sel.removeAllRanges();
            sel.addRange(r);
            editor.focus();
            updatePreview();
            return;
        }

        // --- OZNACZ ---
        if (sel.isCollapsed) return; // nic nie zaznaczono
        const range = sel.getRangeAt(0);
        if (!editor.contains(range.commonAncestorContainer)) return;

        // blokuj zagnieżdżanie: sprawdź czy zaznaczenie dotyka istniejącego .secret
        const fragment = range.cloneContents();
        if (fragment.querySelector('.secret')) return; // zaznaczenie obejmuje .secret
        const startParent = range.startContainer.nodeType === 3 ? range.startContainer.parentElement : range.startContainer;
        const endParent = range.endContainer.nodeType === 3 ? range.endContainer.parentElement : range.endContainer;
        if (startParent && startParent.closest('.secret')) return; // start wewnątrz .secret
        if (endParent && endParent.closest('.secret')) return;   // koniec wewnątrz .secret

        const mark = document.createElement('span');
        mark.className = 'secret';

        try {
            range.surroundContents(mark);
        } catch(e) {
            // fallback nie powinien się zdarzać po naszych guardach, ale na wszelki wypadek
            return;
        }

        // postaw kursor za nowym spanem
        const r = document.createRange();
        r.setStartAfter(mark);
        r.collapse(true);
        sel.removeAllRanges();
        sel.addRange(r);
        editor.focus();
        updatePreview();
    }

    function markSecret() { toggleSecret(); }
    function clearSecret() { toggleSecret(); }

    // --- SKRÓT Ctrl+E ---
    editor.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'e') {
            e.preventDefault();
            toggleSecret();
        }
    });

    // --- PODGLĄD ---
    function updatePreview() {
        const previewBox = document.getElementById('preview');
        const html = editor.innerHTML;

        if (previewMode === 'expired') {
            previewBox.innerHTML = html.replace(
                /<span class="secret">[^<]*<\/span>/g,
                '<span class="masked">●●●●●●</span>'
            );
        } else {
            previewBox.innerHTML = html;
        }
    }

    function setPreview(mode, btn) {
        previewMode = mode;
        document.querySelectorAll('.preview-tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        updatePreview();
    }

    editor.addEventListener('input', updatePreview);

    // --- EKSTRAKCJA DANYCH Z EDYTORA ---
    function extractSections() {
        const sections = [];

        function parseNode(node) {
            if (node.nodeType === 3) {
                sections.push({ type: 'text', content: node.textContent });
            } else if (node.nodeType === 1) {
                if (node.classList && node.classList.contains('secret')) {
                    sections.push({ type: 'secret', content: node.textContent });
                } else if (node.tagName === 'BR') {
                    sections.push({ type: 'text', content: '\n' });
                } else if (node.tagName === 'DIV') {
                    sections.push({ type: 'text', content: '\n' });
                    node.childNodes.forEach(child => parseNode(child));
                } else {
                    node.childNodes.forEach(child => parseNode(child));
                }
            }
        }

        editor.childNodes.forEach(node => parseNode(node));

        // scal sąsiednie tego samego typu
        const merged = [];
        sections.forEach(s => {
            const last = merged[merged.length - 1];
            if (last && last.type === s.type) {
                last.content += s.content;
            } else {
                merged.push({ ...s });
            }
        });

        return merged.filter(s => s.content.length > 0);
    }

    // --- GENERUJ LINK ---
    async function generateLink() {
        // honeypot
        const honeypot = document.querySelector('.ohnohoney').value;

        // treść
        const text = editor.textContent.trim();
        if (!text) {
            alert('Wpisz treść.');
            return;
        }

        // math — sprawdź czy wybrano odpowiedź
        if (selectedAnswer === null) {
            alert('Wybierz odpowiedź na pytanie.');
            return;
        }

        const sections = extractSections();

        const btn = document.querySelector('.generate-btn');
        btn.disabled = true;
        btn.textContent = '...';

        try {
            const resp = await fetch('/api/create.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    website_url: honeypot,
                    sections: sections,
                    expire_days: parseInt(document.getElementById('expireDays').value) || 7,
                    max_views: parseInt(document.getElementById('maxViews').value) || 25,
                    delete_after_days: parseInt(document.getElementById('deleteDays').value) || 30,
                    password: document.getElementById('linkPassword').value.trim() || '',
                    math_expected: mathA + mathB,
                    math_answer: selectedAnswer,
                }),
            });

            const result = await resp.json();

            if (result.ok) {
                document.getElementById('resultUrl').value = result.url;
                document.getElementById('result').classList.add('show');
                // pokaż hasło jeśli było ustawione
                const pwdEl = document.getElementById('resultPassword');
                const pwd = document.getElementById('linkPassword').value.trim();
                if (pwd) {
                    pwdEl.innerHTML = 'Twoje hasło: <strong>' + pwd.replace(/</g, '&lt;') + '</strong>';
                    pwdEl.classList.add('show');
                } else {
                    pwdEl.classList.remove('show');
                    pwdEl.innerHTML = '';
                }
                generateMath();
            } else if (result.error === 'ratelimit') {
                alert('Zbyt wiele prób. Spróbuj później.');
            } else if (result.error === 'math') {
                alert('Nieprawidłowa odpowiedź.');
                generateMath();
            } else {
                alert(result.error || 'Błąd serwera.');
            }
        } catch (e) {
            alert('Błąd połączenia z serwerem.');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Generuj link';
        }
    }

    function copyLink() {
        const input = document.getElementById('resultUrl');
        input.select();
        navigator.clipboard.writeText(input.value).then(() => {
            const btn = document.querySelector('.copy-btn');
            btn.textContent = 'Skopiowano!';
            setTimeout(() => btn.textContent = 'Kopiuj', 2000);
        });
    }

    // init
    updatePreview();
</script>

</body>
</html>
